<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Form</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script type="text/javascript" src="https://jstest.authorize.net/v3/AcceptUI.js" charset="utf-8"></script>
    <style>
        .form-container {
            max-width: 600px;
            margin: 50px auto;
            padding: 30px;
            border: 1px solid #ccc;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="form-container">
            <h2 class="text-center mb-4">Nonce Generation Form</h2>
            <form id="paymentForm" novalidate>
                
                <!-- Product Selection -->
                <div class="mb-3">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="amount" class="form-label">Amount</label>
                            <input type="text" class="form-control" id="amount" placeholder="Amount" required>
                            <small class="text-body-secondary">Amount</small>
                            <div class="invalid-feedback">
                                Valid Amount is required.
                            </div>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="orderdescription" class="form-label">Product Description</label>
                            <input type="text" class="form-control" id="orderdescription" placeholder="Description" required>
                            <small class="text-body-secondary">Product Description</small>
                            <div class="invalid-feedback">
                                Valid Product Description is required.
                            </div>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="invoice" class="form-label">Invoice Number</label>
                            <input type="text" class="form-control" id="invoice" placeholder="Invoice" required>
                            <small class="text-body-secondary">Invoice Number</small>
                            <div class="invalid-feedback">
                                Valid Invoice Number is required.
                            </div>
                        </div>

                    </div>
                </div>

                <!-- Accept UI Integration -->
                <div id="acceptUIContainer">
                    <button class="btn btn-primary" type="button" id="acceptUIBtn">
                        Enter Payment Details
                    </button>
                </div>

                <input type="hidden" id="dataDescriptor" name="dataDescriptor">
                <input type="hidden" id="dataValue" name="dataValue">

                <div class="d-grid mt-3">
                    <button type="submit" class="btn btn-success" id="makePaymentButton">Make Payment</button>
                </div>
            </form>
            <div id="paymentResponse" class="mt-3"></div>
        </div>
    </div>

    <script type="text/javascript">
        document.addEventListener('DOMContentLoaded', function () {
            var form = document.getElementById('paymentForm');
            var makePaymentButton = document.getElementById('makePaymentButton');

            form.addEventListener('submit', function (event) {
                event.preventDefault();
                makePayment();
            });
        });

        document.getElementById('acceptUIBtn').addEventListener('click', function () {
            // Launch Accept UI
            AcceptUI.startPayment({
                // AcceptUI.js parameters
                apiLoginID: "5KP3u95bQpv",
                clientKey: "5FcB6WrfHGS76gHW3v7btBCE3HuuBuke9Pj96Ztfn5R32G5ep42vne7MCWZtAucY",
                acceptUIFormBtnTxt: "Submit Payment",
                acceptUIFormHeaderTxt: "Secure Payment Form",
                responseHandler: handleResponse,
                paymentOptions: {
                    showCreditCard: true,
                    showBankAccount: false
                }
            });
        });

        function handleResponse(response) {
            if (response.messages.resultCode === "Ok") {
                document.getElementById('dataDescriptor').value = response.opaqueData.dataDescriptor;
                document.getElementById('dataValue').value = response.opaqueData.dataValue;
                document.getElementById('paymentResponse').innerHTML = '<p>Payment details received. Ready to submit payment.</p>';
            } else {
                let errorMsg = '<strong>Error:</strong><br>';
                response.messages.message.forEach(function (message) {
                    errorMsg += `${message.code}: ${message.text}<br>`;
                });
                document.getElementById('paymentResponse').innerHTML = errorMsg;
            }
        }

        function makePayment() {
            const dataDescriptor = document.getElementById('dataDescriptor').value;
            const dataValue = document.getElementById('dataValue').value;

            if (!dataDescriptor || !dataValue) {
                document.getElementById("paymentResponse").innerHTML = "<strong>Error:</strong> Please provide valid payment information.";
                return;
            }

            const xmlPayload = `
                <createTransactionRequest xmlns="AnetApi/xml/v1/schema/AnetApiSchema.xsd">
                    <merchantAuthentication>
                        <name>5KP3u95bQpv</name>
                        <transactionKey>346HZ32z3fP4hTG2</transactionKey>
                    </merchantAuthentication>
                    <refId>123456</refId>
                    <transactionRequest>
                        <transactionType>authCaptureTransaction</transactionType>
                        <amount>${document.getElementById("amount").value}</amount>
                        <payment>
                            <opaqueData>
                                <dataDescriptor>${dataDescriptor}</dataDescriptor>
                                <dataValue>${dataValue}</dataValue>
                            </opaqueData>  
                        </payment>
                        <order>
                            <invoiceNumber>${document.getElementById("invoice").value}</invoiceNumber>
                            <description>${document.getElementById("orderdescription").value}</description>
                        </order>
                    </transactionRequest>
                </createTransactionRequest>`;

            fetch('https://apitest.authorize.net/xml/v1/request.api', {
                method: 'POST',
                headers: {
                    'Content-Type': 'text/xml',
                },
                body: xmlPayload,
            })
            .then(response => response.text())
            .then(data => {
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(data, "application/xml");

                const resultCode = xmlDoc.getElementsByTagName("resultCode")[0]?.textContent;
                const responseCode = xmlDoc.getElementsByTagName("responseCode")[0]?.textContent;
                const description = xmlDoc.getElementsByTagName("description")[0]?.textContent;
                const transactionId = xmlDoc.getElementsByTagName("transId")[0]?.textContent;
                const errorCode = xmlDoc.getElementsByTagName("errorCode")[0]?.textContent;
                const errorText = xmlDoc.getElementsByTagName("errorText")[0]?.textContent;

                let responseMessage = '<strong>Payment Response:</strong><br>';

                if (resultCode === 'Ok') {
                    responseMessage += `<p>Transaction Successful!</p>`;
                    responseMessage += `<p><strong>Transaction ID:</strong> ${transactionId}</p>`;
                    responseMessage += `<p><strong>Description:</strong> ${description}</p>`;
                } else {
                    responseMessage += `<p><strong>Error Code:</strong> ${errorCode || responseCode}</p>`;
                    responseMessage += `<p><strong>Message:</strong> ${description || errorText}</p>`;
                }

                document.getElementById("paymentResponse").innerHTML = responseMessage;
            })
            .catch((error) => {
                console.error('Error:', error);
                document.getElementById("paymentResponse").innerHTML = '<strong>Payment Error:</strong> An error occurred while making the payment. Please check your network and try again.';
            });
        }
    </script>
</body>

</html>
